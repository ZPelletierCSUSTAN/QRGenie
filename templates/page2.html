{% extends "page5.html" %}
{% block content %}
<div class="card shadow-lg">
    <div class="card-body p-4">
        <h1 class="text-center text-accent mb-4">Batch QR Code Generator</h1>
        
        <!-- GLOBAL CONTROLS -->
        <div class="border-bottom border-secondary pb-4 mb-4">
            <h5 class="text-accent mb-3">Global Settings</h5>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label text-muted">Shape:</label>
                    <select id="global-shape" class="form-select">
                        <option value="square">Square</option>
                        <option value="rounded">Rounded</option>
                        <option value="circle">Circle</option>
                        <option value="gapped">Gapped</option>
                        <option value="vertical">Vertical</option>
                        <option value="horizontal">Horizontal</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label text-muted">QR Color (Basic):</label>
                    <input type="color" id="global-color" class="form-control form-control-color w-100" value="#000000">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-muted">Size:</label>
                    <input type="range" class="form-range" id="global-size" min="5" max="20" value="10">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-muted">Border:</label>
                    <input type="range" class="form-range" id="global-border" min="0" max="10" value="4">
                </div>
            </div>
            <!-- UPDATED BUTTON TEXT AND COLOR -->
            <button onclick="applyGlobalSettings()" class="btn btn-outline-primary w-100 btn-sm">Apply Settings To All</button>
        </div>

        <!-- INPUT AREA -->
        <div class="mb-3">
            <label class="form-label text-muted">Enter Text (Up to 10 lines):</label>
            <textarea id="batch-input" class="form-control" rows="4" placeholder="https://site1.com&#10;https://site2.com"></textarea>
            <div id="error-msg" class="alert alert-danger mt-2" style="display:none;"></div>
        </div>
        <button onclick="generateBatch()" class="btn btn-primary w-100 mb-4">Generate Batch</button>

        <!-- BATCH GRID AREA -->
        <div id="batch-container" class="batch-container"></div>
        <div id="empty-state" class="text-center text-muted fst-italic mt-5">No QR codes generated yet...</div>
    </div>
</div>

<script>
    let qrList = []; let nextId = 1;
    function getGlobalSettings() {
        return {
            size: document.getElementById('global-size').value,
            border: document.getElementById('global-border').value,
            color: document.getElementById('global-color').value,
            shape: document.getElementById('global-shape').value,
            bg_color: '#ffffff'
        };
    }
    function generateBatch() {
        const text = document.getElementById('batch-input').value;
        const lines = text.split('\n').filter(line => line.trim() !== '');
        if (lines.length > 10) {
            document.getElementById('error-msg').textContent = "Error: Limit of 10 items exceeded.";
            document.getElementById('error-msg').style.display = 'block'; return;
        } else { document.getElementById('error-msg').style.display = 'none'; }
        const settings = getGlobalSettings();
        lines.forEach(line => { qrList.push({ id: nextId++, text: line, ...settings }); });
        document.getElementById('batch-input').value = ""; renderGrid();
    }
    async function renderGrid() {
        const container = document.getElementById('batch-container');
        const emptyState = document.getElementById('empty-state');
        container.innerHTML = "";
        if (qrList.length === 0) { emptyState.style.display = 'block'; return; } 
        else { emptyState.style.display = 'none'; }
        for (let item of qrList) {
            const response = await fetch('/api/generate', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(item)
            });
            const data = await response.json();
            const card = document.createElement('div');
            card.className = 'batch-card';
            card.innerHTML = `
                <button onclick="deleteItem(${item.id})" class="btn-delete" title="Remove">X</button>
                <img src="${data.image}" alt="QR Code">
                <div class="text-truncate" title="${item.text}">${item.text}</div>
                <div class="d-flex gap-2 mt-2 w-100">
                    <a href="${data.image}" download="qr_${item.id}.png" class="btn btn-sm btn-primary flex-grow-1">Save</a>
                    <button onclick="toggleEdit(${item.id})" class="btn btn-sm btn-outline-secondary">Edit</button>
                </div>
                <div id="edit-${item.id}" class="edit-panel">
                    <label>Color:</label><input type="color" class="form-control form-control-color w-100 mb-2" value="${item.color}" onchange="updateItem(${item.id}, 'color', this.value)">
                    <label>Shape:</label>
                    <select class="form-select form-select-sm" onchange="updateItem(${item.id}, 'shape', this.value)">
                        <option value="square" ${item.shape === 'square' ? 'selected' : ''}>Square</option>
                        <option value="rounded" ${item.shape === 'rounded' ? 'selected' : ''}>Rounded</option>
                        <option value="circle" ${item.shape === 'circle' ? 'selected' : ''}>Circle</option>
                        <option value="gapped" ${item.shape === 'gapped' ? 'selected' : ''}>Gapped</option>
                    </select>
                </div>`;
            container.appendChild(card);
        }
    }
    function deleteItem(id) { qrList = qrList.filter(item => item.id !== id); renderGrid(); }
    function updateItem(id, key, value) { const item = qrList.find(i => i.id === id); if (item) { item[key] = value; renderGrid(); } }
    function toggleEdit(id) { const panel = document.getElementById(`edit-${id}`); panel.style.display = panel.style.display === 'block' ? 'none' : 'block'; }
    function applyGlobalSettings() { const settings = getGlobalSettings(); qrList = qrList.map(item => ({ ...item, ...settings })); renderGrid(); }
</script>
{% endblock %}